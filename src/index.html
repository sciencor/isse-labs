<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TodoList</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body data-theme="light">
<div class="app">
    <header>
        <h2>TodoList</h2>
        <div class="theme-toggle">
            <label>
                <input id="themeSwitch" type="checkbox"/> å¤œé—´æ¨¡å¼
            </label>
        </div>
    </header>

    <section class="card">
        <div class="input-row">
            <input id="titleInput" type="text" placeholder="è¾“å…¥å¾…åŠäº‹é¡¹æ ‡é¢˜" />
            <select id="categorySelect">
                <option value="">åˆ†ç±»: æ— </option>
                <option>å­¦ä¹ </option>
                <option>å·¥ä½œ</option>
                <option>ç”Ÿæ´»</option>
            </select>
            <select id="prioritySelect">
                <option value="">ä¼˜å…ˆçº§: æ— </option>
                <option value="low">ä½</option>
                <option value="medium">ä¸­</option>
                <option value="high">é«˜</option>
            </select>
            <input id="dueInput" type="datetime-local" />
            <button id="addBtn">æ·»åŠ ä»»åŠ¡</button>
            <button id="clearBtn" class="ghost">æ¸…ç©ºè¾“å…¥</button>
        </div>

        <div style="margin-top:10px;" class="controls">
            <div>
                æ’åº:
                <select id="sortSelect">
                    <option value="flag">æ——æ ‡ä¼˜å…ˆ</option>
                    <option value="name_asc">æŒ‰å­—å…¸åç§° â†‘</option>
                    <option value="name_desc">æŒ‰å­—å…¸åç§° â†“</option>
                    <option value="created_asc">æŒ‰åˆ›å»ºæ—¶é—´ â†‘</option>
                    <option value="created_desc">æŒ‰åˆ›å»ºæ—¶é—´ â†“</option>
                    <option value="due_asc">æŒ‰ç»“æŸæ—¶é—´ â†‘</option>
                    <option value="due_desc">æŒ‰ç»“æŸæ—¶é—´ â†“</option>
                    <option value="priority">æŒ‰ä¼˜å…ˆçº§ é«˜â†’ä½</option>
                </select>
            </div>
            <div class="muted" style="margin-left:8px;">ï¼ˆæœªå®Œæˆç°è‰²ï¼Œå·²å®Œæˆåˆ é™¤çº¿ï¼Œæ˜Ÿçº§â˜…ï¼Œçº¢æ——ğŸš©ç½®é¡¶ï¼‰</div>
        </div>
    </section>

    <main>
        <section class="card">
            <div class="tasks" id="tasksContainer">
                <!-- ä»»åŠ¡é¡¹ç”±JSæ¸²æŸ“ -->
            </div>
        </section>

        <footer class="card">
            <div class="filters">
                ç­›é€‰:
                <select id="filterCategory">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option>å­¦ä¹ </option>
                    <option>å·¥ä½œ</option>
                    <option>ç”Ÿæ´»</option>
                </select>
                <select id="filterPriority">
                    <option value="">å…¨éƒ¨ä¼˜å…ˆçº§</option>
                    <option value="high">é«˜</option>
                    <option value="medium">ä¸­</option>
                    <option value="low">ä½</option>
                </select>
            </div>
            <div>
                <button id="refreshBtn" class="ghost">åˆ·æ–°</button>
            </div>
        </footer>
    </main>
</div>

<script>
const API_BASE = 'http://127.0.0.1:5000';
const tasksContainer = document.getElementById('tasksContainer');
const titleInput = document.getElementById('titleInput');
const categorySelect = document.getElementById('categorySelect');
const prioritySelect = document.getElementById('prioritySelect');
const dueInput = document.getElementById('dueInput');
const addBtn = document.getElementById('addBtn');
const sortSelect = document.getElementById('sortSelect');
const filterCategory = document.getElementById('filterCategory');
const filterPriority = document.getElementById('filterPriority');
const refreshBtn = document.getElementById('refreshBtn');
const clearBtn = document.getElementById('clearBtn');
const themeSwitch = document.getElementById('themeSwitch');

let tasks = [];

// ä¸»é¢˜åˆ‡æ¢
themeSwitch.addEventListener('change', () => {
    document.body.setAttribute('data-theme', themeSwitch.checked ? 'dark' : 'light');
});

// è½½å…¥ä»»åŠ¡
async function loadTasks(){
    const params = new URLSearchParams();
    const cat = filterCategory.value;
    const pr = filterPriority.value;
    if (cat) params.append('category', cat);
    if (pr) {
        // åç«¯æ²¡æœ‰ priority æŸ¥è¯¢ï¼Œå®¢æˆ·ç«¯åšè¿‡æ»¤
    }
    try{
        const res = await fetch(`${API_BASE}/tasks`);
        const json = await res.json();
        tasks = json.data || [];
        // å®¢æˆ·ç«¯å†æŒ‰ç­›é€‰ä¼˜å…ˆçº§è¿‡æ»¤
        if (pr) tasks = tasks.filter(t => (t.priority || '') === pr);
        renderTasks();
    }catch(e){
        tasksContainer.innerHTML = '<div class="muted">æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¡®ä¿ Flask åœ¨è¿è¡Œå¹¶å…è®¸è·¨åŸŸ (CORS)</div>';
    }
}

// æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
function renderTasks(){
    const sort = sortSelect.value;
    let list = [...tasks];

    // æ——æ ‡ç½®é¡¶
    list.sort((a,b) => (b.flag === true) - (a.flag === true));

    // æ’åºç­–ç•¥
    if (sort === 'name_asc') list.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
    else if (sort === 'name_desc') list.sort((a,b)=> (b.title||'').localeCompare(a.title||''));
    else if (sort === 'created_asc') list.sort((a,b)=> new Date(a.created_at||0) - new Date(b.created_at||0));
    else if (sort === 'created_desc') list.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    else if (sort === 'due_asc') list.sort((a,b)=> new Date(a.due_date||0) - new Date(b.due_date||0));
    else if (sort === 'due_desc') list.sort((a,b)=> new Date(b.due_date||0) - new Date(a.due_date||0));
    else if (sort === 'priority') {
        const rank = p => (p === 'high') ? 3 : (p === 'medium') ? 2 : (p === 'low') ? 1 : 0;
        list.sort((a,b) => rank(b.priority || '') - rank(a.priority || ''));
    }

    // æœªå®Œæˆåœ¨å‰ï¼Œå·²å®Œæˆåœ¨åï¼ˆç¨³å®šï¼‰
    list.sort((a,b)=> (a.completed === b.completed) ? 0 : (a.completed ? 1 : -1));

    tasksContainer.innerHTML = '';
    if (!list.length) {
        tasksContainer.innerHTML = '<div class="muted">æœªæ‰¾åˆ°ä»»åŠ¡</div>';
        return;
    }

    for (const t of list){
        const div = document.createElement('div');
        div.className = 'task card';
        const titleClass = t.completed ? 'title completed' : 'title';
        div.innerHTML = `
            <div style="display:flex;align-items:center;gap:8px;">
                ${t.flag ? '<span class="flag">ğŸš©</span>' : ''}
                ${t.star ? '<span class="star">â˜…</span>' : ''}
            </div>
            <div class="meta">
                <div class="${titleClass}">${escapeHtml(t.title || '(æ— æ ‡é¢˜)')}</div>
                <div class="muted">${escapeHtml(t.category || 'æ— åˆ†ç±»')} Â· ä¼˜å…ˆ:${escapeHtml(t.priority || 'æ— ')} Â· åˆ›å»º:${formatDate(t.created_at)} ${t.due_date ? 'Â· åˆ°æœŸ:' + formatDate(t.due_date) : ''}</div>
            </div>
            <div class="status">
                <div class="muted">${t.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}</div>
                <div class="actions">
                    <button data-id="${t.id}" class="toggleBtn">${t.completed ? 'å–æ¶ˆå®Œæˆ' : 'æ ‡ä¸ºå®Œæˆ'}</button>
                    <button data-id="${t.id}" class="starBtn">${t.star ? 'å–æ¶ˆæ˜Ÿ' : 'æ ‡æ˜Ÿ'}</button>
                    <button data-id="${t.id}" class="flagBtn">${t.flag ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}</button>
                    <button data-id="${t.id}" class="editBtn">ç¼–è¾‘</button>
                    <button data-id="${t.id}" class="delBtn" style="background:#ff4d4f">åˆ é™¤</button>
                </div>
            </div>
        `;
        // è§†è§‰æ ·å¼ï¼šæœªå®Œæˆä¸ºç°è‰²æ–‡æœ¬ï¼ˆtitle not bold white); completed strike applied via class
        if (!t.completed) div.style.opacity = 0.92;

        // ç»‘å®šäº‹ä»¶
        div.querySelector('.toggleBtn').addEventListener('click', ()=> toggleComplete(t.id));
        div.querySelector('.starBtn').addEventListener('click', ()=> toggleField(t.id, 'star', !t.star));
        div.querySelector('.flagBtn').addEventListener('click', ()=> toggleField(t.id, 'flag', !t.flag));
        div.querySelector('.editBtn').addEventListener('click', ()=> editTaskDialog(t));
        div.querySelector('.delBtn').addEventListener('click', ()=> deleteTask(t.id));
        tasksContainer.appendChild(div);
    }
}

// å®‰å…¨çš„æ–‡æœ¬è½¬ä¹‰
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function formatDate(d){ if(!d) return ''; try{ const dt=new Date(d); if(isNaN(dt)) return d; return dt.toLocaleString(); }catch(e){return d;} }

// æ·»åŠ ä»»åŠ¡
addBtn.addEventListener('click', async ()=>{
    const title = titleInput.value.trim();
    if (!title){ alert('è¯·å¡«å†™æ ‡é¢˜'); return; }
    const payload = {
        title,
        category: categorySelect.value || '',
        priority: prioritySelect.value || '',
        due_date: dueInput.value ? new Date(dueInput.value).toISOString() : null,
        flag: false,
        star: false
    };
    try{
        const res = await fetch(`${API_BASE}/tasks`, {
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        const json = await res.json();
        await loadTasks();
        clearInputs();
    }catch(e){
        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨');
    }
});

function clearInputs(){ titleInput.value=''; categorySelect.value=''; prioritySelect.value=''; dueInput.value=''; }

// åˆ‡æ¢å®Œæˆ(åç«¯ PUT åˆ‡æ¢)
async function toggleComplete(id){
    await fetch(`${API_BASE}/tasks/${id}`, { method: 'PUT' });
    await loadTasks();
}

// åˆ‡æ¢å­—æ®µ (PATCH)
async function toggleField(id, field, value){
    await fetch(`${API_BASE}/tasks/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({[field]: value}) });
    await loadTasks();
}

// åˆ é™¤
async function deleteTask(id){
    if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
    await fetch(`${API_BASE}/tasks/${id}`, { method:'DELETE' });
    await loadTasks();
}

// ç¼–è¾‘å¯¹è¯ï¼ˆç®€åŒ–ï¼Œä½¿ç”¨ promptï¼‰
async function editTaskDialog(task){
    const newTitle = prompt('æ ‡é¢˜', task.title || '');
    if (newTitle === null) return;
    const newCategory = prompt('åˆ†ç±»', task.category || '') ?? '';
    const newPriority = prompt('ä¼˜å…ˆçº§ (low/medium/high)', task.priority || '') ?? '';
    const newDue = prompt('åˆ°æœŸï¼ˆISO æˆ– ç©ºï¼‰', task.due_date || '') ?? '';
    const update = { title: newTitle, category: newCategory, priority: newPriority, due_date: newDue || null };
    await fetch(`${API_BASE}/tasks/${task.id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(update) });
    await loadTasks();
}

sortSelect.addEventListener('change', renderTasks);
filterCategory.addEventListener('change', loadTasks);
filterPriority.addEventListener('change', loadTasks);
refreshBtn.addEventListener('click', loadTasks);
clearBtn.addEventListener('click', clearInputs);

// åœ¨ç°æœ‰äº‹ä»¶ç»‘å®šä¸ loadTasks è°ƒç”¨ä¹‹å‰åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰
function createCustomSelect(select){
    // wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'custom-select';
    // trigger button with label and arrow
    const trigger = document.createElement('button');
    trigger.type = 'button';
    trigger.className = 'custom-select__trigger';
    const label = document.createElement('span');
    label.className = 'label';
    label.textContent = select.options[select.selectedIndex]?.text || '';
    const arrow = document.createElement('span');
    arrow.className = 'arrow';
    trigger.appendChild(label);
    trigger.appendChild(arrow);

    // options container
    const opts = document.createElement('div');
    opts.className = 'custom-options';
    Array.from(select.options).forEach(opt => {
        const o = document.createElement('div');
        o.className = 'custom-option';
        o.dataset.value = opt.value;
        o.textContent = opt.text;
        if (opt.disabled) o.classList.add('disabled');
        if (opt.selected) o.classList.add('selected');
        o.addEventListener('click', (e)=>{
            select.value = opt.value;
            // è§¦å‘åŸç”Ÿ change äº‹ä»¶ä»¥é©±åŠ¨å·²æœ‰é€»è¾‘
            select.dispatchEvent(new Event('change', { bubbles: true }));
            // æ›´æ–°æ˜¾ç¤º
            label.textContent = opt.text;
            Array.from(opts.children).forEach(c=>c.classList.toggle('selected', c===o));
            wrapper.classList.remove('open');
        });
        opts.appendChild(o);
    });

    // æ’å…¥åˆ° DOMï¼šæ”¾åœ¨åŸç”Ÿ select åé¢
    select.parentNode.insertBefore(wrapper, select.nextSibling);
    wrapper.appendChild(trigger);
    wrapper.appendChild(opts);

    // éšè—åŸç”Ÿ selectï¼ˆä¿ç•™å¯è®¿é—®æ€§ï¼‰
    select.classList.add('hidden-select');

    // toggle open
    trigger.addEventListener('click', (e)=>{
        e.stopPropagation();
        // å…³é—­å…¶ä»–æ‰“å¼€çš„
        document.querySelectorAll('.custom-select.open').forEach(cs => { if (cs !== wrapper) cs.classList.remove('open'); });
        wrapper.classList.toggle('open');
    });

    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    document.addEventListener('click', (e)=>{ if (!wrapper.contains(e.target)) wrapper.classList.remove('open'); });

    // å½“åŸç”Ÿ select é€šè¿‡è„šæœ¬æ”¹å˜æ—¶ï¼Œæ›´æ–°è‡ªå®šä¹‰ UI
    select.addEventListener('change', ()=>{
        const selOpt = select.options[select.selectedIndex];
        label.textContent = selOpt ? selOpt.text : '';
        Array.from(opts.children).forEach(c=> c.classList.toggle('selected', c.dataset.value === select.value));
    });
}

// åˆå§‹åŒ–éœ€è¦è‡ªå®šä¹‰çš„ selectï¼ˆåœ¨é¡µé¢åŠ è½½æ—¶ï¼‰
['categorySelect','prioritySelect','sortSelect','filterCategory','filterPriority'].forEach(id=>{
    const s = document.getElementById(id);
    if (s) createCustomSelect(s);
});

// åˆå§‹åŠ è½½
loadTasks();
</script>
</body>
</html>